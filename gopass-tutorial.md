# Gopass password store

## Prerequisites
- [Gopass](https://github.com/justwatchcom/gopass) (>= 1.5.0)

```
brew install gopass
```

### Fix GPG pinentry issue

GPG on mac has an issue with pinentry (entering the passphrase to unlock the private key), when used together with gopass. That can lead to decryption of secrets failing.
You can fix this issue by manually installing a pinentry program that works in mac:
```sh
brew install pinentry-mac
```
And then configuring gpg to use that program by editing the file `~/.gnupg/gpg-agent.conf`
and adding the following lines:
```
pinentry-program /usr/local/bin/pinentry-mac
default-cache-ttl 600
max-cache-ttl 7200
```
If there is already a pinentry-program configured, overwrite that line. If the file doesn't exist, create it.

Finally, restart the gpg-agent:
```
killall gpg-agent
```
It will restart itself the next time gpg is used eg. by gopass, so killing it is enough.


## Initialize your own local password store

```sh
gopass init
```

This initalizes the main password store, which we will use to "mount" other secret store repositories into. You may use it to store your own secrets, but you should never use it to store credentials from other password stores.

If `gopass init` says **`No usable private keys found`** then it most probably means, you need to have a GPG private key for yourself. If that the case then Follow:

```sh
brew install gpg
```

and then,

```sh
$ gpg --gen-key
Please select what kind of key you want:
   (1) RSA and RSA (default)
Your selection? 1
What keysize do you want? (2048)
Please specify how long the key should be valid.
         0 = key does not expire
Key is valid for? (0)
Is this correct? (y/N) y
Real name: Your Name
Email address: someone@thoughtworks.com
Comment: -may-leave-it-blank-
.
Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
You need a Passphrase to protect your secret key.
***Enter, re-enter a passphrase. Dont forget this one***
.
pub   2048R/4081FCC5 2017-08-23
      Key fingerprint = 9321 F258 D941 1DC3 3426  DEDC 85FC 148A 4081 FCC5
uid       [ultimate] Your Name (-some-comment-) <someone@thoughtworks.com>
sub   2048R/AC156637 2017-08-23
```

Congratulations! now you have your own GPG keypair. Follow the followoing steps to get your _public_ key added to gopass database:

```sh
$ gpg --armor --export someone@thoughtworks.com > someone-public.key
```

Send the `someone-public.key` file to someone already enlisted to add your key.

Again do `gopass init`. This time it should work.

## Clone the secrets repository

```sh
gopass clone https://github.com/emilyagras/falkorstuff.git falkor
```

_Note: If your public key hasn't been added to the repository yet have somebody with access add you to it._

## Syncing the password store

You'll need to trust the public keys that are added to the password store. Gopass uses the command `sync` to do all the necessary work for you:

```sh
gopass sync
```

## Import gpg keys [Optional]

This steps is optional. But, if running `gopass sync` gives you warnings about gpg public keys not imported to your GPG key chain. Please run:

```sh
gpg --import ~/.password-store-otr/.gpg-keys/*
gopass sync
```

It should now detect the keys you do not have in your local trusted keychain and either ask you if it were to add them or do it automatically for you.

Now, whenever you make any changes to the password store just run `sync` again to push/pull changes.

## Troubleshooting

In case some key might be expired and updated after that, you can request updates from a keyserver for keys that already exist on the local keyring with:

```sh
gpg --refresh-keys
```

## Accessing secrets

Just running `gopass` will give you an overview:

```sh
gopass
```

Reading a secret is done like this:

```sh
gopass show my/special/secret-name
```

Gopass also supports searching for a certain secret with a key:

```sh
gopass special
```

will list all secrets, with a convenient selector, which contain the word `special`. You can also copy the relevant secret directly to your clipboard by adding `-c`:

```sh
$ gopass -c special
```

After your selection gopass will tell you that it added it to your clipboard for 45 seconds (by default).

For all further actions (adding/editing etc.) [please refer to the `gopass` documentation](https://github.com/justwatchcom/gopass#standard-features).

## Adding a secret

You can either generate the secret yourself and add it to the database:

```
$ gopass insert your/special/secret
```

or have it generated by gopass:

```sh
$ gopass generate your/special/secret <length-of-secret> -n
```

**Note: Please use the service name after `otr/secrets` to indicate which service a secret belongs to.**

## Adding a user

You need the public key ID of the user you want to add:

```sh
gpg --import someone-public.key
    gpg: key ABCD12345: public key "Your Name (-something-) <someone@thoughtworks.com>" imported
    gpg: Total number processed: 1
    gpg:               imported: 1  (RSA: 1)
```

Note the `key-id` in the output of the above step: `gpg: key` **`ABCD12345`** <-- this is key-id

Gopass needs the incoming keys to be signed by the person who added it.

```
gpg --edit-key <key-id>

gpg> lsign
...bla...

gpg> trust
...bla...

Your decision? 5
...bla...

gpg> save

gpg --update-trustdb
```

Then you can add the key to gopass:

```sh
gopass recipients add <key-id> --store falkor
```

Now syncronize the store with the upstream repository:

```sh
gopass sync
```

## Deleting a user

You need to figure out the  public key ID of the user you want to delete:

```sh
gopass recipients
```

Then you can delete the key from gopass:

```sh
gopass recipients rm <key-id> --store otr
```

Now syncronize the store with the upstream repository:

```sh
gopass sync
```


## Delete gopass secrets from your machine (if you roll off)

1. delete the directory `~/.password-store-falkor`
2. done!


_Note: Make sure you only allow people to be added to the **falkor** mount inside the store._
